name: Update Pre-commit Hooks

on:
  schedule:
    # Run every Monday at 10:00 UTC (after Dependabot runs at 09:00)
    - cron: '0 10 * * 1'

  workflow_dispatch:  # Allow manual trigger
    inputs:
      auto_commit:
        description: 'Automatically commit changes if updates found'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write

jobs:
  update-hooks:
    name: Auto-update Pre-commit Hooks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: dev  # Always update dev branch
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Get current hook versions
        id: before
        run: |
          echo "## Current Hook Versions" > /tmp/versions_before.txt
          echo "" >> /tmp/versions_before.txt

          # Extract current versions from .pre-commit-config.yaml
          grep -E "^\s*rev:" .pre-commit-config.yaml | sed 's/rev:/- Version:/' >> /tmp/versions_before.txt

          cat /tmp/versions_before.txt

          # Save hash for comparison
          HASH_BEFORE=$(sha256sum .pre-commit-config.yaml | cut -d' ' -f1)
          echo "hash=$HASH_BEFORE" >> $GITHUB_OUTPUT

      - name: Run pre-commit autoupdate
        id: autoupdate
        run: |
          echo "ðŸ”„ Running pre-commit autoupdate..."

          # Run autoupdate and capture output
          pre-commit autoupdate 2>&1 | tee /tmp/autoupdate_output.txt

          echo "âœ… Autoupdate complete"

      - name: Check if hooks were updated
        id: check
        run: |
          HASH_AFTER=$(sha256sum .pre-commit-config.yaml | cut -d' ' -f1)

          if [ "${{ steps.before.outputs.hash }}" != "$HASH_AFTER" ]; then
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "âœ… Hooks were updated"

            # Extract new versions
            echo "## Updated Hook Versions" > /tmp/versions_after.txt
            echo "" >> /tmp/versions_after.txt
            grep -E "^\s*rev:" .pre-commit-config.yaml | sed 's/rev:/- Version:/' >> /tmp/versions_after.txt

            # Show diff
            echo "ðŸ“Š Changes detected:"
            git diff .pre-commit-config.yaml
          else
            echo "updated=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No updates available"
          fi

      - name: Run pre-commit on all files
        if: steps.check.outputs.updated == 'true'
        id: run_hooks
        continue-on-error: true
        run: |
          echo "ðŸ§ª Testing updated hooks on all files..."

          # Run pre-commit on all files to ensure new versions work
          if pre-commit run --all-files; then
            echo "hooks_passed=true" >> $GITHUB_OUTPUT
            echo "âœ… All hooks passed"
          else
            echo "hooks_passed=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  Some hooks failed or made changes"

            # Show what changed
            if ! git diff --quiet; then
              echo "ðŸ“ Auto-fixes applied by hooks:"
              git diff --stat
            fi
          fi

      - name: Commit hook updates and auto-fixes
        if: |
          steps.check.outputs.updated == 'true' &&
          (github.event.inputs.auto_commit == 'true' || github.event_name == 'schedule')
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stage all changes (hook config + any auto-fixes)
          git add .pre-commit-config.yaml

          # Stage any files modified by hooks running
          if ! git diff --quiet; then
            git add -u
          fi

          # Check if there are changes to commit
          if ! git diff --cached --quiet; then
            # Create commit message
            COMMIT_MSG="chore(pre-commit): auto-update hooks

          Updated pre-commit hooks to their latest versions.

          Changes applied by pre-commit autoupdate command.

          Auto-generated by pre-commit-autoupdate workflow."

            git commit -m "$COMMIT_MSG"
            git push origin dev

            echo "âœ… Changes committed and pushed to dev branch"
            echo "committed=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸  No changes to commit"
            echo "committed=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request for updates
        if: |
          steps.check.outputs.updated == 'true' &&
          github.event.inputs.auto_commit != 'true' &&
          github.event_name == 'workflow_dispatch'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore(pre-commit): auto-update hooks

            Updated pre-commit hooks to their latest versions.
          branch: chore/pre-commit-autoupdate-${{ github.run_number }}
          title: 'chore(pre-commit): Auto-update pre-commit hooks'
          body: |
            ## ðŸ”„ Pre-commit Hook Auto-update

            This PR contains automatic updates to pre-commit hooks.

            ### Changes

            <details>
            <summary>View autoupdate output</summary>

            ```
            ${{ steps.autoupdate.outputs.output }}
            ```

            </details>

            ### Hook Test Results

            ${{ steps.run_hooks.outputs.hooks_passed == 'true' && 'âœ… All hooks passed on test run' || 'âš ï¸ Some hooks failed or made auto-fixes (see commits)' }}

            ### Review Checklist

            - [ ] Review version changes in `.pre-commit-config.yaml`
            - [ ] Check that CI passes
            - [ ] Verify hooks work locally: `pre-commit run --all-files`

            ---

            ðŸ¤– *Auto-generated by [`pre-commit-autoupdate`](.github/workflows/pre-commit-autoupdate.yml) workflow*
          labels: |
            dependencies
            pre-commit
            automated
          base: dev
          delete-branch: true

      - name: Post summary
        if: always()
        run: |
          echo "## Pre-commit Hook Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check.outputs.updated }}" = "true" ]; then
            echo "âœ… **Updates Available**: Yes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Before" >> $GITHUB_STEP_SUMMARY
            cat /tmp/versions_before.txt >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### After" >> $GITHUB_STEP_SUMMARY
            cat /tmp/versions_after.txt >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "${{ steps.run_hooks.outputs.hooks_passed }}" = "true" ]; then
              echo "âœ… **Hook Test**: All passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ **Hook Test**: Some failed or made changes" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "${committed:-false}" = "true" ]; then
              echo "âœ… **Action**: Changes committed to \`dev\` branch" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              echo "ðŸ“ **Action**: Pull request created for review" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ **Updates Available**: No" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All pre-commit hooks are already at their latest versions." >> $GITHUB_STEP_SUMMARY
          fi

# ==============================================================================
# Configuration Notes
# ==============================================================================
#
# WORKFLOW BEHAVIOR:
# - Runs every Monday at 10:00 UTC (1 hour after Dependabot)
# - Can be manually triggered via workflow_dispatch
# - Automatically commits to 'dev' branch on schedule
# - Creates PR for manual review when triggered manually
# - Tests updated hooks on all files before committing
# - Stages any auto-fixes applied by hooks
#
# SCHEDULE vs MANUAL:
# - Schedule (cron): Auto-commits to dev branch
# - Manual trigger: Creates PR with auto_commit option
# - Set auto_commit=false in manual trigger to create PR instead
#
# ALTERNATIVE: pre-commit.ci
# Instead of this workflow, consider using https://pre-commit.ci:
#
# Pros of pre-commit.ci:
# - Zero configuration (just install the GitHub App)
# - Automatic PR creation with hook updates
# - Runs hooks on every PR automatically
# - Free for open-source projects
# - No GitHub Actions minutes consumed
#
# Pros of this workflow:
# - Full control over update schedule and behavior
# - Can customize commit messages and PR format
# - Works entirely within your repository
# - No external service dependency
#
# To use pre-commit.ci instead:
# 1. Install the app: https://github.com/apps/pre-commit-ci
# 2. Delete this workflow file
# 3. Add .pre-commit-ci.yaml config (optional):
#
#    # .pre-commit-ci.yaml
#    autoupdate_schedule: weekly
#    autoupdate_commit_msg: 'chore(pre-commit): auto-update hooks'
#    autofix_commit_msg: 'style: auto-fixes from pre-commit hooks'
#
# CUSTOMIZATION:
# - Change schedule in cron expression
# - Modify target branch (currently 'dev')
# - Adjust Python version if needed
# - Add additional hook testing steps
# - Customize commit message format
#
