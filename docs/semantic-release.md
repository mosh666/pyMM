# Semantic Release Configuration

This document explains the semantic versioning and automated release system used in pyMM.

## Overview

pyMM uses [python-semantic-release](https://python-semantic-release.readthedocs.io/) to automate version
management and releases based on [Conventional Commits](https://www.conventionalcommits.org/).

## Current Configuration

### Version: python-semantic-release v9.8.8

We use **v9.8.8** (not the latest v10.x) because:

- **v10.x has a bug**: The `major_on_zero = false` setting is ignored, causing BREAKING CHANGE commits to
  incorrectly bump to v1.0.0
- **v9.8.8 works correctly**: Properly respects `major_on_zero = false` and keeps versions at v0.y.z during
  beta phase

### Configuration Location

All configuration is in `pyproject.toml`:

```toml
[tool.semantic_release]
commit_message = "{version}\n\nAutomatically generated by python-semantic-release"
commit_parser = "conventional"  # v9-compatible format
logging_use_named_masks = false
major_on_zero = false  # CRITICAL: Prevents v1.0.0 during beta
tag_format = "v{version}"
build_command = "uv build"  # Uses hatchling backend

[tool.semantic_release.commit_parser_options]
major_on_zero = false  # Explicit setting for parser

[tool.semantic_release.branches.main]
match = "main"
prerelease_token = "rc"
prerelease = false
major_on_zero = false  # Branch-specific (doesn't inherit from root)

[tool.semantic_release.branches.dev]
match = "dev"
prerelease = true
prerelease_token = "beta"
major_on_zero = false  # Branch-specific (doesn't inherit from root)
```

## Version Bumping Rules

### On `dev` Branch (Prerelease/Beta)

**Important**: On the `dev` branch with `prerelease = true`, all commits increment only the **prerelease
number**, regardless of commit type.

| Current Version | Commit Type | New Version | Notes |
| --------------- | ----------- | ----------- | ----- |
| `v0.2.0-beta.60` | `fix:` | `v0.2.0-beta.61` | Increments beta number |
| `v0.2.0-beta.60` | `feat:` | `v0.2.0-beta.61` | Increments beta number |
| `v0.2.0-beta.60` | `feat!:` or `BREAKING CHANGE:` | `v0.2.0-beta.61` | Increments beta number |
| `v0.2.0-beta.60` | `docs:`, `chore:`, `refactor:` | No change | Excluded from releases |

**Key Behavior**: The actual version bump (patch/minor/major) is **not calculated on dev**. It's only
determined when you merge `dev` → `main`, at which point semantic-release analyzes all commits since the
last stable release.

### On `main` Branch (Stable) - During Beta Phase (v0.y.z)

With `major_on_zero = false`, when merging to `main`:

| Commit Type | Example | Version Change | Notes |
| ----------- | ------- | -------------- | ----- |
| `fix:` | `fix(ui): correct button alignment` | 0.1.0 → 0.1.1 | Patch bump |
| `feat:` | `feat(sync): add compression` | 0.1.0 → 0.2.0 | Minor bump |
| `feat!:` or `BREAKING CHANGE:` | `feat!: redesign API` | 0.1.0 → 0.2.0 | Minor bump (not major!) |
| `docs:`, `chore:`, `refactor:` | Any docs/refactor commits | No change | Excluded from releases |

**Key Behavior**: Even with `BREAKING CHANGE`, versions stay at v0.y.z. Breaking changes bump **minor**
version instead of major.

### On `main` Branch (Stable) - After v1.0.0 Release

Once `major_on_zero = true`:

| Commit Type | Example | Version Change |
| ----------- | ------- | -------------- |
| `fix:` | `fix(ui): correct button` | 1.0.0 → 1.0.1 |
| `feat:` | `feat(sync): add feature` | 1.0.0 → 1.1.0 |
| `feat!:` or `BREAKING CHANGE:` | `feat!: redesign API` | 1.0.0 → 2.0.0 |

## Branch Strategy

### `dev` Branch (Beta Releases)

- **Prerelease**: `true`
- **Prerelease Token**: `beta`
- **Format**: `v0.y.z-beta.N`
- **Trigger**: Automatic on push + daily at 1 AM UTC
- **Purpose**: Continuous beta releases for testing

### `main` Branch (Stable Releases)

- **Prerelease**: `false`
- **Prerelease Token**: `rc` (for release candidates)
- **Format**: `v0.y.z` or `v1.y.z`
- **Trigger**: Manual merge from dev
- **Purpose**: Production-ready releases

## v0.y.z Enforcement

### Why Stay at v0.y.z?

During beta development, we enforce v0.y.z versioning to signal:

1. **API Stability**: APIs may change without warning
2. **Feature Completeness**: Not all planned features are implemented
3. **Production Readiness**: Not yet recommended for production use
4. **Testing Phase**: Active development and breaking changes expected

### Protection Layers

Multiple safeguards prevent accidental v1.0.0 releases:

#### Layer 1: Build-Time Validation (hatch-vcs)

```toml
[tool.hatch.version]
source = "vcs"

[tool.hatch.build.hooks.vcs]
version-file = "app/_version.py"
tag-pattern = "^v(?P<version>0\\.[0-9]+\\.[0-9]+(?:-[a-zA-Z0-9]+(?:\\.[0-9]+)?)?)$"
```

This configuration ensures hatch-vcs only recognizes tags matching the v0.y.z pattern.

- Blocks v1+ tags during package builds
- Only accepts v0.y.z format

#### Layer 2: CI/CD Guardrail (GitHub Actions)

```yaml
- name: Validate version stays in v0.y.z range
  if: steps.semantic.outputs.new_release_published == 'true'
  run: |
    VERSION="${{ steps.semantic.outputs.new_release_version }}"
    MAJOR_VERSION=$(echo "$VERSION" | sed -E 's/^([0-9]+)\..*/\1/')
    if [ "$MAJOR_VERSION" != "0" ]; then
      echo "::error::❌ Version $VERSION exceeds v0.y.z range!"
      exit 1
    fi
```

- Validates version after semantic-release calculates it
- Fails workflow if major version != 0

#### Layer 3: Pre-Commit Hook

```yaml
- id: validate-version-tags
  name: Validate Version Tags (v0.y.z only)
  entry: python -c "..."
  language: python
  stages: [pre-push]
```

- Runs before git push
- Validates tags at HEAD match v0.y.z format

#### Layer 4: PR Checklist

`.github/PULL_REQUEST_TEMPLATE.md` includes a collapsible v1.0.0 release checklist that maintainers must
complete before merging the v1.0.0 release.

#### Layer 5: Documentation

`CONTRIBUTING.md` documents the complete v1.0.0 release process with pre-release requirements and step-by-step instructions.

## Common Issues

### Issue: Semantic-release calculates v1.0.0 instead of v0.2.0

**Cause**: Using python-semantic-release v10.x

**Solution**: Ensure v9.15.0 or later is installed:

```bash
uv tool install 'python-semantic-release>=9.15.0,<10.0.0'
# or for current project
uv pip install --system 'python-semantic-release>=9.15.0,<10.0.0'
```

**Why**: v9.15.0+ includes important bug fixes while v10.x ignores `major_on_zero = false` setting.

### Issue: Branch configuration not working

**Cause**: Branch-specific configs don't inherit from root

**Solution**: Explicitly set `major_on_zero = false` in each branch config:

```toml
[tool.semantic_release.branches.dev]
match = "dev"
prerelease = true
major_on_zero = false  # Must be explicit!
```

### Issue: Version not bumping on feat commits

**Check**:

1. Commit message follows conventional format: `feat(scope): description`
2. Pre-commit hooks passed (validates commit format)
3. Not using excluded types (`docs`, `chore`, `refactor`, etc.)

**Verify locally**:

```bash
python -m semantic_release version --print --no-commit --no-tag --no-push
```

## Testing Locally

### Preview Next Version

```bash
# See what version would be calculated
python -m semantic_release version --print --no-commit --no-tag --no-push
```

### Dry Run Release

```bash
# Simulate release without pushing
python -m semantic_release version --no-push
```

### Check Configuration

```python
# Verify major_on_zero setting is loaded
python -c "
import tomllib
with open('pyproject.toml', 'rb') as f:
    cfg = tomllib.load(f)
    psr = cfg['tool']['semantic_release']
    print(f\"Root major_on_zero: {psr.get('major_on_zero')}\")
    print(f\"Main branch: {psr['branches']['main'].get('major_on_zero')}\")
    print(f\"Dev branch: {psr['branches']['dev'].get('major_on_zero')}\")
"
```

## Upgrading to v1.0.0

When the project is ready for v1.0.0, follow this process:

### Pre-Release Checklist

✅ **Feature Completeness**

- All planned v1.0.0 features implemented
- APIs stable and documented
- User guide complete

✅ **Quality Assurance**

- Test coverage ≥80%
- No critical bugs
- Security audit completed
- Performance benchmarks met

✅ **Production Hardening**

- Error handling robust all platforms
- Logging system production-ready
- Backup/recovery procedures documented
- Rollback strategy defined

### Release Steps

1. **Update Configuration** in `pyproject.toml`:

   ```toml
   [tool.hatch.build.hooks.vcs]
   # Allow v1+ versions
   tag-pattern = "^v(?P<version>[0-9]+\\.[0-9]+\\.[0-9]+(?:-[a-zA-Z0-9]+(?:\\.[0-9]+)?)?)$"

   [tool.semantic_release]
   major_on_zero = true  # Allow major bumps

   [tool.semantic_release.branches.main]
   major_on_zero = true

   [tool.semantic_release.branches.dev]
   major_on_zero = true
   ```

2. **Remove Version Validation** from `.github/workflows/semantic-release.yml`:
   - Delete the "Validate version stays in v0.y.z range" step

3. **Remove Pre-Commit Hook** from `.pre-commit-config.yaml`:
   - Delete the "Validate Version Tags" hook

4. **Create GitHub Discussion**: "v1.0.0 Release Planning"

5. **Stabilization Period**:
   - Create final beta: `v0.y.z-beta.N`
   - Wait 1 week minimum
   - Fix any critical issues found

6. **Merge and Release**:
   - Merge `dev` → `main`
   - Manually create annotated tag:

     ```bash
     git tag -a v1.0.0 -m "Release 1.0.0"
     git push origin v1.0.0
     ```

7. **Post-Release**:
   - Update documentation version references
   - Announce release on GitHub Discussions
   - Update README.md badges to "stable"

### Consider Upgrading python-semantic-release

Once v1.0.0 is released, check if python-semantic-release v10.x has fixed the `major_on_zero` bug.
If fixed, upgrade to latest:

```bash
uv tool install python-semantic-release --upgrade
```

Update workflow to use GitHub Action:

```yaml
- name: Python Semantic Release
  uses: python-semantic-release/python-semantic-release@v10.latest
  with:
    github_token: ${{ secrets.GITHUB_TOKEN }}
```

## Changelog Management

Semantic-release automatically:

- Generates changelog from commits
- Updates `CHANGELOG.md`
- Creates GitHub release notes
- Includes all `feat` and `fix` commits
- Excludes `docs`, `chore`, `refactor`, etc.

## GitHub Actions Workflow

### Triggers

The semantic-release workflow runs on:

1. **Push to dev/main branches**: Automatic release on every push
2. **Daily schedule**: 1:00 AM UTC for dev branch only
3. **Manual dispatch**: Via GitHub Actions UI

### Workflow Steps

1. **Check for Changes**: Compares current HEAD with last tag
2. **Run Semantic Release**: Calculates version and creates tag
3. **Validate Version**: Ensures v0.y.z during beta phase
4. **Build Artifacts**: Creates platform-specific builds (Windows MSI, Linux AppImage, macOS DMG)
5. **Create Release**: Publishes GitHub release with artifacts
6. **Cleanup**: Removes old beta releases (keeps last 5)

### Manual Release

To manually trigger a release:

1. Go to **Actions** → **Semantic Release**
2. Click **Run workflow**
3. Select branch (`dev` or `main`)
4. Optionally check **Force release** to bypass change detection
5. Click **Run workflow**

## Troubleshooting

### Workflow fails with "No changes"

**Normal behavior**: Semantic-release skips if no `feat`/`fix` commits since last tag.

**To force**: Use manual workflow dispatch with "Force release" option.

### Workflow fails with "v1.0.0 exceeds v0.y.z range"

**Good!** This means protection is working.

**Root cause**: Check if using python-semantic-release v10.x or if `major_on_zero = false` is missing from branch configs.

**Fix**: Ensure v9.8.8 is installed and all configurations have `major_on_zero = false`.

### Tag created but workflow fails

**Rollback**:

```bash
# Delete local tag
git tag -d v0.y.z-beta.N

# Delete remote tag
git push --delete origin v0.y.z-beta.N
```

Then fix the issue and try again.

## Best Practices

### Commit Messages

Always use conventional commit format:

```text
<type>(<scope>): <subject>

<body>

<footer>
```

**Types that trigger releases**:

- `feat:` - New feature (minor bump)
- `fix:` - Bug fix (patch bump)
- `perf:` - Performance improvement (patch bump)

**Types excluded from releases**:

- `docs:` - Documentation
- `chore:` - Maintenance
- `refactor:` - Code refactoring
- `style:` - Code formatting
- `test:` - Tests
- `build:` - Build system (except `build(deps)`)

### Breaking Changes

During v0.y.z phase:

```text
feat!: redesign plugin API

BREAKING CHANGE: Plugin interface changed from v1 to v2.
Plugins must implement new `initialize()` method.
```

This bumps minor version: 0.1.0 → 0.2.0 (NOT 0.1.0 → 1.0.0)

### Scope Guidelines

Use descriptive scopes:

- `feat(ui):` - User interface changes
- `feat(sync):` - Synchronization features
- `feat(plugin):` - Plugin system
- `fix(release):` - Release process fixes
- `fix(ci):` - CI/CD fixes

### Using [skip ci] and Skip Directives

Add skip directives to commit messages to control which CI jobs run:

**Available Directives:**

```text
docs: update README [skip ci]               # Skip ALL CI (except security)
test: refactor helper [skip tests]          # Skip tests only
style: format code [skip lint]              # Skip linting only
build: update deps [skip build]             # Skip build jobs only
```

**When to use:**

- `[skip ci]` - Documentation-only changes, trivial fixes
- `[skip tests]` - Minor refactoring that doesn't change behavior
- `[skip lint]` - Emergency hotfixes (fix code first, lint later)
- `[skip build]` - Changes that don't affect build artifacts

**When NOT to use:**

- Any code changes (app/, tests/)
- Configuration changes (pyproject.toml, workflows)
- Changes that need validation

**Smart Features:**

- **Auto-Skip:** CI automatically skips on docs-only changes (non-PR commits)
- **Security Protection:** Security scans always run, even with skip directives
- **Pre-commit Validation:** Hook prevents misuse (install: `pre-commit install`)
- **Skip Reporting:** Detailed summary shows what was skipped and why

**Note:** Semantic-release workflow automatically adds `[skip ci]` to its own commits to prevent infinite loops.

## Troubleshooting Common Issues

### CHANGELOG.md Not Updating Automatically

**Symptoms:**

- Git tags are created successfully
- GitHub releases are published
- But CHANGELOG.md shows no new commits

**Root Cause:** Git not configured in semantic-release workflow

**Solution:** Ensure `.github/workflows/semantic-release.yml` includes git configuration before running semantic-release:

```yaml
- name: Configure Git for semantic-release
  run: |
    git config user.name "semantic-release"
    git config user.email "semantic-release@github.com"

- name: Python Semantic Release
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    GIT_COMMIT_AUTHOR: "semantic-release <semantic-release>"
```

**Verification:**

```bash
# Check recent commits by semantic-release
git log --author="semantic-release" --oneline -5

# Should show commits like:
# abc1234 chore(release): 0.2.0-beta.X [skip ci]
```

### No Release Created

**Symptoms:** Push to dev/main branch but no new version tag created

**Common Causes:**

1. **No releasable commits** - Only `docs:`, `chore:`, `style:` commits since last release
2. **Commit format incorrect** - Not following conventional commit format
3. **Workflow not triggered** - Check GitHub Actions tab

**Solution:**

```bash
# Verify commit format
git log --oneline -5

# Ensure at least one feat:/fix: commit exists
# Re-run workflow manually if needed (Actions → semantic-release → Run workflow)
```

## References

- [Conventional Commits Specification](https://www.conventionalcommits.org/)
- [Python Semantic Release Documentation](https://python-semantic-release.readthedocs.io/)
- [Semantic Versioning 2.0.0](https://semver.org/)
- [Keep a Changelog](https://keepachangelog.com/)

## Related Documentation

- [CONTRIBUTING.md](https://github.com/mosh666/pyMM/blob/main/CONTRIBUTING.md) - Contribution guidelines
  and v1.0.0 release process
- [troubleshooting.md](troubleshooting.md) - Version troubleshooting
- [architecture.md](architecture.md) - Overall project architecture
