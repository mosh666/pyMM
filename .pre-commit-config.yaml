# Pre-commit hooks for pyMediaManager
# See https://pre-commit.com for more information
# Run: pre-commit install
# Test: pre-commit run --all-files

repos:
  # Ruff - fast Python linter and formatter (2026 latest)
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.11  # Update to latest 2026 release
    hooks:
      # Run the linter
      - id: ruff
        args: [--fix, --exit-non-zero-on-fix, --ignore, RUF100]
        name: Ruff Linter (auto-fix)
      # Run the formatter
      - id: ruff-format
        name: Ruff Formatter

  # Basic file checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        name: Trim Trailing Whitespace
      - id: end-of-file-fixer
        name: Fix End of Files
      - id: check-yaml
        name: Check YAML Syntax
      - id: check-added-large-files
        args: ['--maxkb=1000']
        name: Check for Large Files (>1MB)
      - id: check-merge-conflict
        name: Check for Merge Conflicts
      - id: check-toml
        name: Check TOML Syntax
      - id: mixed-line-ending
        args: ['--fix=lf']
        name: Fix Mixed Line Endings
      - id: check-json
        name: Check JSON Syntax
      - id: check-case-conflict
        name: Check Filename Case Conflicts
      - id: detect-private-key
        name: Detect Private Keys
      - id: check-ast
        name: Check Python AST
      - id: check-builtin-literals
        name: Check Builtin Type Constructor Use
      - id: check-docstring-first
        name: Check Docstring First
      - id: debug-statements
        name: Check for Debugger Imports
      - id: name-tests-test
        name: Check Test Naming
        args: ['--pytest-test-first']
        exclude: '^tests/(fixtures|__pycache__|\.pytest_cache)/.*'

  # Commit Message Linting (Conventional Commits)
  - repo: https://github.com/compilerla/conventional-pre-commit
    rev: v4.3.0
    hooks:
      - id: conventional-pre-commit
        stages: [commit-msg]
        args: []

  # Markdown linting
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.47.0
    hooks:
      - id: markdownlint
        name: Markdown Linter
        args: [--fix, --disable, MD013, MD024, MD033, MD041]

  # Documentation quality checks
  - repo: local
    hooks:
      - id: doc8
        name: doc8 - Markdown/RST Linter
        entry: python -m doc8
        language: system
        files: \.(md|rst)$
        args:
          - --max-line-length=100
          - --ignore-path=docs/_build
          - --quiet

      - id: interrogate
        name: interrogate - Docstring Coverage
        entry: python -m interrogate
        language: system
        types: [python]
        args:
          - --fail-under=100
          - -v
          - --ignore-init-method
          - --ignore-init-module
          - --ignore-magic
          - --ignore-module
          - --ignore-nested-functions
          - --ignore-private
          - --ignore-property-decorators
          - --ignore-semiprivate
          - --exclude=tests
          - --exclude=docs
        pass_filenames: true

  # Python type checking with mypy (local environment)
  - repo: local
    hooks:
      - id: mypy
        name: MyPy Type Checker
        entry: just type-check
        language: system
        types: [python]
        pass_filenames: false
        always_run: true

  # Note: Safety check removed as it only supports Poetry projects

  # Run pytest before commit (fast tests only)
  - repo: local
    hooks:
      - id: pytest-check
        name: PyTest - Unit Tests (Fast)
        entry: just test-unit
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]

      - id: pytest-full
        name: PyTest - All Tests (Pre-Push)
        entry: just test
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-push]

      - id: docs-check
        name: Documentation Validation
        entry: python
        language: system
        pass_filenames: false
        always_run: true
        args:
          - -c
          - |
            import re
            import sys
            from pathlib import Path

            # Check for TODO/FIXME in docs
            docs_path = Path('docs')
            readme = Path('README.md')

            issues = []
            for doc in [readme] + list(docs_path.glob('*.md')):
                content = doc.read_text(encoding='utf-8')
                if 'TODO' in content or 'FIXME' in content:
                    issues.append(f"{doc}: Contains TODO/FIXME")

            if issues:
                print("⚠️  Documentation issues found:")
                for issue in issues:
                    print(f"  - {issue}")
                print("\n✅ Note: This is a warning, not blocking commit")
            else:
                print("✅ Documentation validation passed")
        stages: [pre-push]

  # Version validation - prevent v1+ tags during beta phase
  - repo: local
    hooks:
      - id: validate-version-tag
        name: Validate Version Tags (v0.y.z only)
        entry: python
        language: system
        pass_filenames: false
        always_run: false
        stages: [pre-push]
        args:
          - -c
          - |
            import subprocess
            import sys
            import re

            # Get all tags being pushed
            result = subprocess.run(
                ['git', 'tag', '--points-at', 'HEAD'],
                capture_output=True,
                text=True
            )

            if result.returncode != 0:
                sys.exit(0)  # No tags, allow push

            tags = result.stdout.strip().split('\n')
            tags = [t for t in tags if t]  # Remove empty strings

            if not tags:
                sys.exit(0)  # No tags at HEAD, allow push

            # Validate each tag
            v0_pattern = re.compile(r'^v0\.[0-9]+\.[0-9]+(?:-[a-zA-Z0-9]+(?:\.[0-9]+)?)?$')
            invalid_tags = []

            for tag in tags:
                if not v0_pattern.match(tag):
                    invalid_tags.append(tag)

            if invalid_tags:
                print("\n❌ Version Validation Failed!")
                print("\nThe following tags do not match the v0.y.z format:")
                for tag in invalid_tags:
                    print(f"  - {tag}")
                print("\n⚠️  This project is in beta phase and must use v0.y.z versioning.")
                print("\nAllowed formats:")
                print("  ✅ v0.1.0")
                print("  ✅ v0.1.0-beta.1")
                print("  ✅ v0.2.0-alpha.1")
                print("  ❌ v1.0.0 (blocked until v1.0.0 release process)")
                print("\nTo release v1.0.0, follow the process in CONTRIBUTING.md")
                print("and update .pre-commit-config.yaml to remove this validation.\n")
                sys.exit(1)

            print("✅ Version validation passed - all tags are v0.y.z format")

  # Validate [skip ci] usage
  - repo: local
    hooks:
      - id: validate-skip-ci
        name: Validate [skip ci] Directives
        entry: python scripts/validate_skip_ci.py
        language: system
        stages: [commit-msg]
        always_run: true
        pass_filenames: false

# CI configuration
ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes from pre-commit.com hooks

    for more information, see https://pre-commit.ci
  autofix_prs: true
  autoupdate_branch: ''
  autoupdate_commit_msg: '[pre-commit.ci] pre-commit autoupdate'
  autoupdate_schedule: weekly
  skip: [pytest-check, pytest-full, docs-check, mypy, doc8, interrogate]
  submodules: false
